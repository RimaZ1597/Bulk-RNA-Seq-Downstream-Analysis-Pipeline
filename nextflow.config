/*
========================================================================================
    HIGHLY ACCURATE RNA-seq ANALYSIS PIPELINE CONFIGURATION
========================================================================================
    Following Nextflow best practices and GitHub package implementations
    Pipeline: Batch Correction → Power Analysis → DE Analysis → Pathway Analysis
========================================================================================
*/

params {
    // Core Input Parameters
    config_file        = 'analysis_config.yaml'  // Generated by Setup.py
    project_name       = null                     // Override experiment ID
    outdir            = 'results'                 // Base output directory
    
    // Container Definitions (for reproducibility)
    containers = [
        combatseq     : '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif',

        limma         : '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif',
        power_analysis: '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif',
        reactome      : '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif',
        kegg          : '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif',
        fgsea         : '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif',
        humangem      : '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif',
        enrichment    : '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
    ]
    
    // Output directory
    output_dir = 'results'
    
    // Resource Limits (adjusted for current system)
    max_memory = '32.GB'
    max_cpus   = 2
    max_time   = '24.h'
    
    // Pipeline Validation
    validate_params   = true
    monochrome_logs  = false
    help             = false
    
    // Warning suppression
    publish_dir_mode = 'copy'
}

/*
========================================================================================
    PROCESS RESOURCE CONFIGURATION
========================================================================================
*/

process {
    // Global process settings
    beforeScript = 'export PATH="/nfs_home/software/singularity/3.8.1/bin/bin:$PATH"'
    
    // Resource labels (adjusted for 2 CPU system)
    withLabel: process_low {
        cpus   = { check_max( 1,     'cpus'    ) }
        memory = { check_max( 4.GB,  'memory'  ) }
        time   = { check_max( 2.h,   'time'    ) }
    }
    withLabel: process_medium {
        cpus   = { check_max( 2,     'cpus'    ) }
        memory = { check_max( 8.GB,  'memory'  ) }
        time   = { check_max( 4.h,   'time'    ) }
    }
    withLabel: process_high {
        cpus   = { check_max( 2,     'cpus'    ) }
        memory = { check_max( 16.GB, 'memory'  ) }
        time   = { check_max( 8.h,   'time'    ) }
    }
    
    // Module-specific configurations
    withName: 'COMBATSEQ' {
        container = params.containers.combatseq
        label = 'process_medium'
    }
    withName: 'RNASEQPOWER' {
        container = params.containers.power_analysis
        label = 'process_medium'
    }

    withName: 'LIMMA_ANALYSIS' {
        container = params.containers.limma
        label = 'process_high'
        memory = { check_max( 24.GB, 'memory' ) }
    }
    withName: 'REACTOME_ANALYSIS' {
        container = params.containers.reactome
        label = 'process_medium'
    }
    withName: 'KEGG_ANALYSIS' {
        container = params.containers.kegg
        label = 'process_medium'
    }
    withName: 'FGSEA_ANALYSIS' {
        container = params.containers.fgsea
        label = 'process_medium'
    }
    withName: 'HUMANGEM_ANALYSIS' {
        container = params.containers.humangem
        label = 'process_high'
        memory = { check_max( 28.GB, 'memory' ) }
    }
    withName: 'ENRICHMENT_ANALYSIS' {
        container = params.containers.enrichment
        label = 'process_medium'
    }
    
    // Power Analysis specific settings
    withName: 'RNASEQPOWER_PROCESS' {
        container = params.containers.power_analysis
        label = 'process_medium'
    }
}

/*
========================================================================================
    UTILITY FUNCTIONS
========================================================================================
*/

// Function to ensure that resource requirements don't go beyond maximum limits
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "   ### ERROR ###   Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}

// Singularity configuration
singularity {
    enabled = true
    autoMounts = true
    runOptions = '-B /novo'
    cacheDir = '/novo/projects/departments/compbio/sysbio/users/rvwx/.singularity_cache'
}

// Profiles
profiles {
    standard {
        process.executor = 'local'
        process.container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
    }
    cluster {
        process.executor = 'slurm'
        process.queue = 'compute'
        process.container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
        process.clusterOptions = '--account=sysbio'
    }
}

// Reports
timeline {
    enabled = true
    file = "${params.output_dir}/pipeline_info/timeline.html"
    overwrite = true
}
report {
    enabled = true
    file = "${params.output_dir}/pipeline_info/report.html"
    overwrite = true
}
trace {
    enabled = true
    file = "${params.output_dir}/pipeline_info/trace.txt"
    overwrite = true
}
dag {
    enabled = true
    file = "${params.output_dir}/pipeline_info/dag.html"
    overwrite = true
}

// Manifest
manifest {
    name = 'rna-seq-combat'
    author = 'RNA-seq Pipeline'
    description = 'Complete RNA-seq analysis pipeline with ComBat-seq batch correction'
    version = '1.0.0'
    nextflowVersion = '>=21.10.3'
}

// Logging configuration to reduce verbose warnings
env {
    NXF_ANSI_LOG = false
}
