// Nextflow configuration file for Multi-Dataset RNA-seq Pipeline
params {
    // Input files (will be overridden by command line)
    counts = null
    metadata = null
    config_yaml = 'conf/analysis_config.yaml'
    study_name = 'default_study'  // Support for study-specific naming
    
    // Dataset selection flags
    LAMTOR_KD = false
    REPSOX = false
    Adipose_Endothelial_Cell_Flow = false
    
    // Output
    output_dir = 'results'
    
    // Execution settings
    max_memory = '16.GB'
    max_cpus = 1
    max_time = '6.h'
    
    // Help message
    help = false
    
    // Validation flags
    validate_params = true
    
    // Output options
    save_intermediate = true
    publish_dir_mode = 'copy'
    
    // Analysis options (matching your requirements)
    csv_only = true           // Only CSV outputs, no visualizations
    skip_go_enrichment = true // Skip GO enrichment analysis
    all_pathways = true       // Report all pathways (no p-value filtering)
    contrast_folders = true   // Organize results by contrast
}

// Process configuration - CONSOLIDATED
process {
    // Default settings
    cpus = 1
    memory = '4.GB'
    time = '2.h'
    beforeScript = 'export PATH="/nfs_home/software/singularity/3.8.1/bin/bin:$PATH"'
    
    // Error handling defaults
    errorStrategy = 'retry'
    maxRetries = 2
    
    // ComBat-seq specific settings
    withName: COMBAT_SEQ {
        cpus = 1
        memory = { task.attempt <= 3 ? 8.GB * task.attempt : 24.GB }
        time = { 4.h * task.attempt }
        container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
        publishDir = [
            path: { params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD/01_Batch_correction" :
                    params.REPSOX ? "${params.output_dir}/REPSOX/01_Batch_correction" :
                    params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow/01_Batch_correction" :
                    "${params.output_dir}/${params.study_name}/01_Batch_correction" },
            mode: 'copy'
        ]
        errorStrategy = 'retry'
        maxRetries = 3
    }
    
    // Power Analysis specific settings
    withName: POWER_ANALYSIS {
        cpus = 1
        memory = { task.attempt <= 2 ? 10.GB * task.attempt : 20.GB }
        time = { 3.h * task.attempt }
        container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
        publishDir = [
            path: { params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD/02_Power_analysis" :
                    params.REPSOX ? "${params.output_dir}/REPSOX/02_Power_analysis" :
                    params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow/02_Power_analysis" :
                    "${params.output_dir}/${params.study_name}/02_Power_analysis" },
            mode: 'copy'
        ]
        errorStrategy = 'retry'
        maxRetries = 2
    }
    
    // DESeq2 specific settings
    withName: DESEQ2_ANALYSIS {
        cpus = 1
        memory = { task.attempt <= 2 ? 12.GB * task.attempt : 24.GB }
        time = { 4.h * task.attempt }
        container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
        publishDir = [
            path: { params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD" :
                    params.REPSOX ? "${params.output_dir}/REPSOX" :
                    params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow" :
                    "${params.output_dir}/${params.study_name}" },
            mode: 'copy'
        ]
        errorStrategy = 'retry'
        maxRetries = 3
    }
    
    // Pathway Analysis specific settings
    withName: PATHWAY_ANALYSIS {
        cpus = 1
        memory = { task.attempt <= 2 ? 12.GB * task.attempt : 24.GB }
        time = { 8.h * task.attempt }
        container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
        publishDir = [
            path: { params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD" :
                    params.REPSOX ? "${params.output_dir}/REPSOX" :
                    params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow" :
                    "${params.output_dir}/${params.study_name}" },
            mode: 'copy'
        ]
        errorStrategy = 'finish'  // Continue pipeline even if pathway analysis fails
        maxRetries = 2
    }
    
    // Label-based configurations (more flexible)
    withLabel: 'validate_data' {
        cpus = 1
        memory = '4.GB'
        time = '1.h'
        container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
    }
    
    withLabel: 'clean_metadata' {
        cpus = 1
        memory = '2.GB'
        time = '1.h'
        container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
    }
    
    withLabel: 'combat_seq' {
        cpus = 1
        memory = '8.GB'
        time = '4.h'
        container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
        publishDir = [
            path: { params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD/01_Batch_correction" :
                    params.REPSOX ? "${params.output_dir}/REPSOX/01_Batch_correction" :
                    params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow/01_Batch_correction" :
                    "${params.output_dir}/${params.study_name}/01_Batch_correction" },
            mode: 'copy'
        ]
    }
    
    withLabel: 'power_analysis' {
        cpus = 1
        memory = '12.GB'
        time = '3.h'
        container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
        publishDir = [
            path: { params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD/02_Power_analysis" :
                    params.REPSOX ? "${params.output_dir}/REPSOX/02_Power_analysis" :
                    params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow/02_Power_analysis" :
                    "${params.output_dir}/${params.study_name}/02_Power_analysis" },
            mode: 'copy'
        ]
    }
    
    withLabel: 'deseq2' {
        cpus = 1
        memory = '15.GB'
        time = '4.h'
        container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
        publishDir = [
            path: { params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD" :
                    params.REPSOX ? "${params.output_dir}/REPSOX" :
                    params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow" :
                    "${params.output_dir}/${params.study_name}" },
            mode: 'copy'
        ]
    }
    
    withLabel: 'pathway_analysis' {
        cpus = 1
        memory = '14.GB'
        time = '8.h'
        container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
        publishDir = [
            path: { params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD" :
                    params.REPSOX ? "${params.output_dir}/REPSOX" :
                    params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow" :
                    "${params.output_dir}/${params.study_name}" },
            mode: 'copy'
        ]
    }
}

// Singularity configuration
singularity {
    enabled = true
    autoMounts = true
    runOptions = '-B /novo'
    cacheDir = '/novo/projects/departments/compbio/sysbio/users/rvwx/.singularity_cache'
}

// Profiles
profiles {
    standard {
        process.executor = 'local'
        process.container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
    }
    
    cluster {
        process.executor = 'slurm'
        process.queue = 'compute'
        process.container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
        process.clusterOptions = '--account=sysbio'
        
        // Cluster-specific resource limits
        process {
            withName: COMBAT_SEQ {
                queue = 'compute'
                clusterOptions = '--account=sysbio --partition=compute'
            }
            withName: POWER_ANALYSIS {
                queue = 'compute'
                clusterOptions = '--account=sysbio --partition=compute'
            }
            withName: DESEQ2_ANALYSIS {
                queue = 'compute'
                clusterOptions = '--account=sysbio --partition=compute'
            }
            withName: PATHWAY_ANALYSIS {
                queue = 'compute'
                clusterOptions = '--account=sysbio --partition=compute'
                time = '12.h'  // Extended time for pathway analysis
            }
        }
    }
    
    // Development profile for testing
    dev {
        process.executor = 'local'
        process.container = '/novo/projects/departments/compbio/sysbio/users/rvwx/containers/NF_BulkRNAseq.sif'
        
        // Reduced resources for development
        process {
            memory = '2.GB'
            time = '1.h'
            
            withName: COMBAT_SEQ {
                memory = '4.GB'
                time = '2.h'
            }
            withName: POWER_ANALYSIS {
                memory = '4.GB'
                time = '1.h'
            }
            withName: DESEQ2_ANALYSIS {
                memory = '4.GB'
                time = '2.h'
            }
            withName: PATHWAY_ANALYSIS {
                memory = '4.GB'
                time = '2.h'
            }
        }
    }
}

// Docker configuration (alternative to Singularity)
docker {
    enabled = false  // Disabled by default, use Singularity
    temp = 'auto'
}

// Resource monitoring
monitor {
    enabled = true
}

// Reports configuration (study-specific paths)
timeline {
    enabled = true
    file = params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD/pipeline_info/timeline.html" :
           params.REPSOX ? "${params.output_dir}/REPSOX/pipeline_info/timeline.html" :
           params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow/pipeline_info/timeline.html" :
           "${params.output_dir}/${params.study_name}/pipeline_info/timeline.html"
    overwrite = true
}

report {
    enabled = true
    file = params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD/pipeline_info/report.html" :
           params.REPSOX ? "${params.output_dir}/REPSOX/pipeline_info/report.html" :
           params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow/pipeline_info/report.html" :
           "${params.output_dir}/${params.study_name}/pipeline_info/report.html"
    overwrite = true
}

trace {
    enabled = true
    file = params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD/pipeline_info/trace.txt" :
           params.REPSOX ? "${params.output_dir}/REPSOX/pipeline_info/trace.txt" :
           params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow/pipeline_info/trace.txt" :
           "${params.output_dir}/${params.study_name}/pipeline_info/trace.txt"
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
    overwrite = true
}

dag {
    enabled = true
    file = params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD/pipeline_info/dag.html" :
           params.REPSOX ? "${params.output_dir}/REPSOX/pipeline_info/dag.html" :
           params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow/pipeline_info/dag.html" :
           "${params.output_dir}/${params.study_name}/pipeline_info/dag.html"
    overwrite = true
}

// Work directory configuration
workDir = params.LAMTOR_KD ? "${params.output_dir}/LAMTOR_KD/work" :
           params.REPSOX ? "${params.output_dir}/REPSOX/work" :
           params.Adipose_Endothelial_Cell_Flow ? "${params.output_dir}/Adipose_Endothelial_Cell_Flow/work" :
           "${params.output_dir}/${params.study_name}/work"

// Cleanup configuration
cleanup = false  // Set to true to automatically clean work directory

// Notification configuration
notification {
    enabled = false
    to = 'user@email.com'  // Set your email for notifications
}

// Manifest
manifest {
    name = 'multi-dataset-rna-seq-combat'
    author = 'RNA-seq Pipeline Team'
    description = 'Multi-dataset RNA-seq analysis pipeline with ComBat-seq batch correction, CSV-only outputs, and contrast-based organization'
    version = '2.0.0'
    nextflowVersion = '>=21.10.3'
    homePage = 'https://github.com/your-repo/rna-seq-pipeline'
    mainScript = 'main.nf'
}

// Custom functions for parameter validation
def checkPathParam(param_name, param_value) {
    if (param_value) {
        def file_obj = file(param_value)
        if (!file_obj.exists()) {
            error "File specified by ${param_name} does not exist: ${param_value}"
        }
        return file_obj
    }
    return null
}