# BulkRNAseq Pipeline - Limma-Voom Framework

A comprehensive Nextflow DSL2 pipeline for bulk RNA-seq differential expression analysis using the limma-voom statistical framework with integrated batch correction, pathway analysis, and power assessment.

## ğŸ§¬ Overview

This pipeline provides a complete solution for bulk RNA-seq analysis, from raw count matrices to publication-ready results. It integrates ComBat-seq batch correction, limma-voom differential expression analysis, FGSEA pathway enrichment, and statistical power analysis in a unified, reproducible workflow.

### Key Features

- **Interactive Configuration**: Wizard-based setup for experimental design
- **Batch Correction**: ComBat-seq integration with automatic detection
- **Differential Expression**: limma-voom with multi-factor design support
- **Pathway Analysis**: HumanGEM + MSigDB pathway enrichment via FGSEA
- **Power Analysis**: Statistical power assessment and sample size recommendations
- **Containerization**: Docker/Singularity support for reproducibility
- **Interactive Analysis**: Pluto.jl notebook integration for exploration

## Project Structure

```
BulkRNAseq_Pipeline_Limma_Copy/
â”œâ”€â”€ ğŸ“„ main.nf                    # Main pipeline entry point
â”œâ”€â”€ âš™ï¸ nextflow.config            # Global pipeline configuration
â”œâ”€â”€ ğŸ“‹ requirements.txt           # Python dependencies
â”œâ”€â”€ ğŸ§¬ subsystem_genes.csv        # HumanGEM pathway gene mappings
â”œâ”€â”€ ğŸ”§ analysis_config.yaml       # Analysis configuration (generated by setup.py)
â”œâ”€â”€ ğŸ§ª run_pipeline_test.sh       # Pipeline testing script
â”œâ”€â”€ ğŸ“š WORKFLOW_VERIFICATION.md   # Workflow validation documentation
â”‚
â”œâ”€â”€ ğŸ“‚ bin/                       # R analysis scripts
â”‚   â”œâ”€â”€ combat_seq.R              # ComBat-seq batch correction
â”‚   â”œâ”€â”€ limma.R                   # limma-voom differential expression
â”‚   â”œâ”€â”€ pathway_analysis.R        # FGSEA pathway enrichment
â”‚   â”œâ”€â”€ power_analysis.R          # RNASeqPower statistical analysis
â”‚   â””â”€â”€ README.md                 # Scripts documentation
â”‚
â”œâ”€â”€ ğŸ“‚ conf/                      # Configuration files
â”‚   â”œâ”€â”€ nextflow.config           # Main Nextflow configuration
â”‚   â”œâ”€â”€ modules.config            # Module-specific settings
â”‚   â”œâ”€â”€ api_config.yml           # External API configurations
â”‚   â””â”€â”€ README.md                 # Configuration documentation
â”‚
â”œâ”€â”€ ğŸ“‚ data/                      # Input datasets and results
â”‚   â”œâ”€â”€ PLX182687/               # Example: Shear stress experiment
â”‚   â”œâ”€â”€ PLX007704/               # Additional experimental datasets
â”‚   â”œâ”€â”€ PLX060659/               # More datasets...
â”‚   â””â”€â”€ README.md                 # Data organization guide
â”‚
â”œâ”€â”€ ğŸ“‚ interactive_setup/         # Configuration wizard
â”‚   â”œâ”€â”€ setup.py                 # Interactive configuration generator
â”‚   â”œâ”€â”€ utils_io.py             # Input/output utilities
â”‚   â”œâ”€â”€ utils_pluto.py          # Pluto.jl integration
â”‚   â”œâ”€â”€ data/                   # Sample datasets for wizard testing
â”‚   â””â”€â”€ README.md                 # Setup documentation
â”‚
â”œâ”€â”€ ğŸ“‚ modules/local/             # Nextflow DSL2 modules
â”‚   â”œâ”€â”€ combat_seq/              # ComBat-seq module
â”‚   â”œâ”€â”€ limma/                   # limma-voom module
â”‚   â”œâ”€â”€ pathway_analysis/        # Pathway analysis module
â”‚   â”œâ”€â”€ power_analysis/          # Power analysis module
â”‚   â””â”€â”€ README.md                 # Module documentation
â”‚
â”œâ”€â”€ ğŸ“‚ workflows/                 # Nextflow workflow definitions
â”‚   â”œâ”€â”€ combatseq.nf             # Batch correction workflow
â”‚   â”œâ”€â”€ limma.nf                 # Differential expression workflow
â”‚   â”œâ”€â”€ pathway_analysis.nf      # Pathway enrichment workflow
â”‚   â”œâ”€â”€ rnaseqpower.nf          # Power analysis workflow
â”‚   â””â”€â”€ README.md                 # Workflow documentation
â”‚
â””â”€â”€ ğŸ“‚ work/                      # Nextflow execution cache (auto-generated)
```

## ğŸš€ Quick Start

### 1. Environment Setup

```bash
# Clone or navigate to pipeline directory
cd BulkRNAseq_Pipeline_Limma_Copy

# Activate Python virtual environment
source ~/.venv/bin/activate

# Verify Python dependencies
pip install -r requirements.txt
```

### 2. Interactive Configuration

```bash
# Run the configuration wizard
cd interactive_setup
python setup.py

# Follow the interactive prompts to:
# - Select your dataset
# - Define experimental factors
# - Specify contrasts of interest
# - Configure analysis parameters
```

### 3. Pipeline Execution

```bash
# Return to main directory
cd ..

# Run the complete pipeline
nextflow run main.nf

# Or run with specific configuration
nextflow run main.nf --config_file interactive_setup/analysis_config.yaml

# Run with containers (recommended)
nextflow run main.nf -profile docker

# Run specific analysis steps only
nextflow run main.nf --skip_power_analysis
```

## ğŸ“Š Analysis Workflow

### Step 1: Batch Correction (ComBat-seq)
- **Input**: Raw count matrix + sample metadata
- **Process**: Automatic batch effect detection and correction
- **Output**: Batch-corrected counts + quality metrics
- **Location**: `data/{PROJECT_ID}/analysis_results/combatseq/`

### Step 2: Differential Expression (limma-voom)
- **Input**: Corrected counts + experimental design
- **Process**: TMM normalization, voom transformation, statistical testing
- **Output**: Complete DE results for all contrasts
- **Location**: `data/{PROJECT_ID}/analysis_results/limma/`

### Step 3: Pathway Analysis (FGSEA)
- **Input**: DE results per contrast + pathway databases
- **Process**: Gene set enrichment analysis (HumanGEM + MSigDB)
- **Output**: Enriched pathways with FDR correction
- **Location**: `data/{PROJECT_ID}/analysis_results/pathway_analysis/`

### Step 4: Power Analysis (RNASeqPower)
- **Input**: Original + corrected counts + metadata
- **Process**: Statistical power assessment and sample size recommendations
- **Output**: Power comparisons + future study recommendations
- **Location**: `data/{PROJECT_ID}/analysis_results/power_analysis/`

## ğŸ“ˆ Expected Results

### Batch Correction Output
```
combatseq/
â”œâ”€â”€ combatseq_corrected_counts.csv    # Batch-corrected expression matrix
â”œâ”€â”€ combatseq_original_counts.csv     # Filtered original counts
â”œâ”€â”€ combatseq_metadata.csv           # Aligned sample metadata
â””â”€â”€ combatseq_log.txt               # Analysis log and QC metrics
```

### Differential Expression Output
```
limma/
â”œâ”€â”€ analysis_summary.csv              # Summary statistics across contrasts
â”œâ”€â”€ all_contrasts_combined_results.csv # All DE results combined
â”œâ”€â”€ normalized_counts_cpm.csv         # TMM-normalized CPM values
â”œâ”€â”€ voom_log2cpm.csv                 # Voom-transformed expression
â””â”€â”€ {CONTRAST_NAME}/                  # Per-contrast results
    â”œâ”€â”€ all_genes_results.csv        # Complete DE results (no filtering)
    â”œâ”€â”€ significant_genes.csv        # FDR < 0.05 genes only
    â”œâ”€â”€ volcano_plot.png            # Volcano plot visualization
    â””â”€â”€ ma_plot.png                 # MA plot visualization
```

### Pathway Analysis Output
```
pathway_analysis/
â””â”€â”€ {CONTRAST_NAME}/
    â”œâ”€â”€ ranked_gene_list.csv          # Genes ranked by significance
    â”œâ”€â”€ humangem_subsystem_pathways.csv # HumanGEM metabolic pathways
    â”œâ”€â”€ msigdb_Hallmark_pathways.csv   # Hallmark gene sets
    â”œâ”€â”€ msigdb_KEGG_pathways.csv      # KEGG pathways
    â”œâ”€â”€ msigdb_GO_pathways.csv        # Gene Ontology terms
    â””â”€â”€ pathway_analysis_summary.csv   # Summary statistics
```

### Power Analysis Output
```
power_analysis/
â”œâ”€â”€ power_distribution_original.csv      # Power before batch correction
â”œâ”€â”€ power_distribution_corrected.csv     # Power after batch correction
â”œâ”€â”€ power_comparison_original_vs_corrected.csv # Improvement metrics
â”œâ”€â”€ recommended_sample_sizes.csv         # Future study recommendations
â””â”€â”€ power_analysis_log.txt              # Detailed interpretation guide
```

## âš™ï¸ Configuration

### Analysis Configuration (analysis_config.yaml)
Generated by the interactive setup wizard:

```yaml
project_name: "Experiment_ID_Contrast_Type"

experimental_design:
  primary_factor: "shear_stress"
  batch_factor: "plate_number"
  additional_factors: ["donor", "cell_type"]

analysis_parameters:
  perform_batch_correction: true
  perform_differential_expression: true
  perform_pathway_analysis: true
  perform_power_analysis: true

comparisons:
  - "donor__shear_stress_High_vs_Static"
  - "donor__shear_stress_Medium_vs_Static"
  - "donor__vs__shear_stress_High"

filtering_config:
  method: "count_based"
  threshold: 10
  min_samples: 3
```

### Pipeline Parameters
Override via command line or nextflow.config:

```bash
# Statistical thresholds
--fdr_threshold 0.05
--logfc_threshold 1.0

# Resource limits
--max_memory 128.GB
--max_cpus 16
--max_time 240.h

# Analysis control
--skip_batch_correction
--skip_pathway_analysis
--skip_power_analysis
```

## ğŸ³ Container Support

### Docker (Recommended)
```bash
# Run with Docker containers
nextflow run main.nf -profile docker

# Specify custom container
nextflow run main.nf -profile docker \
  --container 'rvwx/rnaseq-limma:latest'
```

### Singularity (HPC Environments)
```bash
# Run with Singularity
nextflow run main.nf -profile singularity

# Custom Singularity cache directory
nextflow run main.nf -profile singularity \
  --singularity_cache_dir /shared/containers
```

### Required Software (Container Contents)
- **R â‰¥ 4.0**: Statistical computing environment
- **R Packages**: limma, edgeR, sva, fgsea, msigdbr, RNASeqPower
- **Python â‰¥ 3.8**: Interactive setup components
- **System Tools**: curl, wget for database access

## ğŸ’¾ Resource Requirements

### Minimum System Requirements
- **CPU**: 4 cores
- **Memory**: 16 GB RAM
- **Storage**: 50 GB free space
- **OS**: Linux/macOS with Docker/Singularity support

### Recommended for Large Datasets
- **CPU**: 16+ cores
- **Memory**: 64+ GB RAM
- **Storage**: 500+ GB free space
- **Network**: High-speed internet for database downloads

### Resource Scaling
The pipeline automatically adjusts resource allocation based on:
- Dataset size (genes Ã— samples)
- Number of contrasts
- Pathway database size
- Available system resources

## ğŸ§ª Testing and Validation

### Quick Test
```bash
# Run pipeline test script
bash run_pipeline_test.sh

# Manual test with minimal data
nextflow run main.nf -profile test,docker \
  --config_file test_configs/minimal.yaml
```

### Validation Checks
The pipeline includes built-in validation for:
- **Input Files**: Format, completeness, sample alignment
- **Statistical Results**: Sanity checks and outlier detection
- **Output Files**: Required file generation and format validation
- **Resource Usage**: Memory and CPU consumption monitoring

### Expected Test Results
- **Runtime**: 5-15 minutes for test dataset
- **Outputs**: All expected files generated successfully
- **Logs**: No error messages in `.nextflow.log`
- **Results**: Reasonable statistical values and plots

## ğŸ”§ Troubleshooting

### Common Issues and Solutions

#### 1. Memory Errors
```bash
# Increase memory allocation
nextflow run main.nf --max_memory 256.GB

# Check available system memory
free -h
```

#### 2. Container Issues
```bash
# Verify Docker/Singularity installation
docker --version
singularity --version

# Clear container cache
docker system prune -a
```

#### 3. Input File Problems
```bash
# Validate file formats
head -5 data/PROJECT_ID/counts.csv
head -10 data/PROJECT_ID/metadata.csv

# Check file permissions
ls -la data/PROJECT_ID/
```

#### 4. Configuration Errors
```bash
# Validate YAML syntax
python -c "import yaml; yaml.safe_load(open('analysis_config.yaml'))"

# Re-run configuration wizard
cd interactive_setup && python setup.py
```

#### 5. Execution Failures
```bash
# Resume failed execution
nextflow run main.nf -resume

# Check detailed logs
tail -100 .nextflow.log
cat work/*/*/.command.log
```

### Debug Mode
```bash
# Enable debug output
nextflow run main.nf -with-trace -with-report -with-timeline

# Generate execution reports
ls -la pipeline_info/
```

## ğŸ“š Documentation

### Detailed Component Documentation
- **ğŸ“‚ bin/README.md**: R analysis scripts documentation
- **ğŸ“‚ conf/README.md**: Configuration files guide
- **ğŸ“‚ data/README.md**: Data organization and formats
- **ğŸ“‚ interactive_setup/README.md**: Configuration wizard guide
- **ğŸ“‚ modules/local/README.md**: Nextflow modules documentation
- **ğŸ“‚ workflows/README.md**: Workflow definitions guide

### External Resources
- **Limma User Guide**: https://bioconductor.org/packages/limma/
- **ComBat-seq Paper**: https://doi.org/10.1093/nargab/lqaa078
- **FGSEA Documentation**: https://bioconductor.org/packages/fgsea/
- **Nextflow Documentation**: https://nextflow.io/docs/latest/
- **nf-core Guidelines**: https://nf-co.re/docs/contributing/guidelines

## ğŸ¤ Contributing

### Development Workflow
1. **Fork Repository**: Create personal fork for modifications
2. **Create Branch**: Feature-specific development branches
3. **Test Changes**: Validate with test datasets
4. **Document Updates**: Update relevant README files
5. **Submit PR**: Pull request with clear description

### Adding New Features
- **New Analysis Steps**: Add modules in `modules/local/`
- **New Workflows**: Create workflow files in `workflows/`
- **Configuration Options**: Update setup wizard and configs
- **Documentation**: Update all relevant README files

### Code Standards
- **Nextflow**: Follow nf-core DSL2 conventions
- **R Code**: Use tidyverse and Bioconductor best practices
- **Python Code**: Follow PEP 8 style guidelines
- **Documentation**: Clear, comprehensive, example-driven

## ğŸ“„ Citation

If you use this pipeline in your research, please cite:

```
BulkRNAseq Pipeline - Limma-Voom Framework
https://github.com/your-org/BulkRNAseq_Pipeline_Limma_Copy
```

Plus the underlying tools:
- **limma**: Ritchie et al. (2015) Nucleic Acids Research
- **ComBat-seq**: Zhang et al. (2020) NAR Genomics and Bioinformatics
- **FGSEA**: Korotkevich et al. (2021) PNAS
- **Nextflow**: Di Tommaso et al. (2017) Nature Biotechnology

## Support

### Getting Help
1. **Documentation**: Check relevant README files in subdirectories
4. **Email Support**: zinjuwadiarima@gmail.com

### Reporting Bugs
Please include:
- **System Information**: OS, container system, resource availability
- **Pipeline Version**: Git commit hash or release version
- **Input Data**: Description of dataset characteristics
- **Error Messages**: Complete error logs and stack traces
- **Reproduction Steps**: Minimal example to reproduce issue

## ğŸ“Š Performance Benchmarks

### Typical Performance (16 cores, 64GB RAM)
- **Small Dataset** (5K genes, 20 samples): 10-20 minutes
- **Medium Dataset** (20K genes, 50 samples): 30-60 minutes
- **Large Dataset** (30K genes, 100+ samples): 2-4 hours

### Bottlenecks and Optimization
- **ComBat-seq**: CPU-intensive for large sample sizes
- **limma-voom**: Memory-intensive for high gene counts
- **Pathway Analysis**: Network-dependent for database downloads
- **Power Analysis**: CPU-intensive for multiple effect sizes

## ğŸ”„ Version History

### Current Version: 1.0.0
- âœ… Complete limma-voom integration
- âœ… ComBat-seq batch correction
- âœ… FGSEA pathway analysis
- âœ… RNASeqPower analysis
- âœ… Interactive setup wizard
- âœ… Comprehensive documentation

### Planned Features
- ğŸ”„ Additional DE methods (DESeq2, edgeR)
- ğŸ”„ Enhanced visualizations
- ğŸ”„ Cloud deployment options
- ğŸ”„ Automated report generation
- ğŸ”„ Multi-species support

---

**ğŸ§¬ Developed for comprehensive downstream bulk RNA-seq analysis with reproducible** ğŸ§¬
